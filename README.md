# deicer

![an image showing a cartoon version of a glacier splitting and melting.](https://github.com/rossja/deicer/blob/main/docs/img/logo.jpg)

# AWS Glacier Vault Cleanup Tool

This script helps automate the process of cleaning up AWS Glacier vaults, handling the various requirements and waiting periods that AWS imposes when deleting vaults.

## Overview

Deleting an AWS Glacier vault requires several steps:
1. Request an inventory of the vault (which can take 3-5 hours to complete)
2. Delete all archives in the vault
3. Wait 24 hours after archive deletion
4. Delete the vault itself

This script manages this process by:
- Tracking vault and job states in a JSON file
- Managing inventory retrieval jobs
- Tracking archive deletion status
- Respecting AWS's 24-hour waiting period
- Providing status updates on the process

## Prerequisites

- Python 3.x
- AWS credentials with appropriate permissions
- Required Python packages: provided via `poetry install` or `pip install -r requirements.txt`

## Configuration

1. Create a `.env` file in the same directory as the script (use `.env.example` as a guide):
```ini
AWS_ACCESS_KEY_ID=your_access_key_here
AWS_SECRET_ACCESS_KEY=your_secret_key_here
AWS_DEFAULT_REGION=us-east-1  # optional, defaults to us-east-1

# If using temporary credentials (e.g., AWS SSO):
AWS_SESSION_TOKEN=your_session_token_here
```

2. Ensure your AWS credentials have permissions for:
   - `glacier:ListVaults`
   - `glacier:InitiateJob`
   - `glacier:DescribeJob`
   - `glacier:GetJobOutput`
   - `glacier:DeleteArchive`
   - `glacier:DeleteVault`

## Usage

The script operates in several modes:

### Initial Scan
```bash
python deicer.py --scan
```
- Lists all vaults in the account
- Initiates inventory retrieval jobs for each vault
- Creates/updates the state file

### Check Status
```bash
python deicer.py --status
```
- Shows current status of all vaults
- Displays job progress
- Shows time elapsed since archive deletion

### Regular Update
```bash
python deicer.py
```
- Checks progress of inventory jobs
- Processes completed inventories
- Deletes archives when inventories complete
- Attempts vault deletion after 24-hour waiting period

### Debug Mode
```bash
python deicer.py --debug
```
- Enables detailed logging
- Shows credential validation
- Displays API responses

### Additional Options
```bash
python deicer.py --help
```
- `--log-file PATH`: Specify custom log file location
- `--state-file PATH`: Specify custom state file location (default: glacier_state.json)

## Status Values

The script tracks the following states for each vault:

| Status | Description |
|--------|-------------|
| `null` | No inventory job started |
| `in-progress` | Inventory retrieval job running |
| `complete` | Inventory retrieved successfully |
| `archives_deleted` | All archives deleted, waiting 24-hour period |
| `error` | Error occurred during processing |

## State File Format

The script maintains a JSON state file (default: `glacier_state.json`):
```json
{
  "vault-name": {
    "job_id": "job-id-123",
    "status": "in-progress",
    "job_updated": "2024-02-15T10:30:45+00:00",
    "archives": []
  }
}
```

## Logging

- Logs are written to both console and file
- Default log file: `glacier_cleanup_TIMESTAMP.log`
- Debug logs include full timestamps and detail
- Regular logs show essential information only

## Best Practices

1. Run initial scan:
   ```bash
   python deicer.py --scan --debug
   ```

2. Check status periodically:
   ```bash
   python deicer.py --status
   ```

3. Run regular updates (can be automated):
   ```bash
   python deicer.py
   ```

## Common Issues

1. **Invalid Credentials**
   - Ensure `.env` file exists and contains valid credentials
   - Check AWS credential permissions

2. **Job Taking Long Time**
   - Inventory retrieval typically takes 3-5 hours but may take days
   - Script handles this automatically

3. **Vault Deletion Failing**
   - Must wait 24 hours after archive deletion
   - Script tracks this waiting period automatically

## Notes

- AWS Glacier has strict rate limits; the script respects these
- Inventory jobs can take several hours to several days to complete
- There is a mandatory 24-hour wait after deleting archives
- The script tracks state, but does not run in the background.
- AWS recommends a minimum 900 second (15 minute) interval between status checks. Use cron or whatever your favorite scheduling tool is to automate checking on the job status.
- AWS may charge for inventory retrieval jobs

## License

This project is licensed under the Apache v2 License - see the LICENSE file for details.

*special disclaimer: this code was generated by AI, specifically the [Claude 3.5 sonnet](https://www.anthropic.com/news/claude-3-5-sonnet) model*